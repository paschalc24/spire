<script>
    import Modal from "./Modal.svelte";
    import { onMount } from "svelte";
    import { CartStore } from "../routes/stores.js";
    export let studentId;
    let showModal = false;
    let cart = [];

    onMount(async () => {
        const cartRes = await fetch(`http://localhost:4003/carts/${studentId}`);
        const cartData = await cartRes.json();
        console.log("ON MOUNT CART", cartData);
        CartStore.set(cartData);
    });

    CartStore.subscribe(async (_cart) => {
        console.log(`Cart List Subscribe: ${JSON.stringify(_cart)}`);
        cart = _cart;
    });
    
    async function handleDelete(course) {
        try {
            await fetch(`http://localhost:4003/carts/${studentId}/${course}`, {
                method: "DELETE",
            });
            CartStore.update((cart) => {
                return cart.filter(e => e !== course);
            })
        }
        catch (err) {
            console.error(err);
            alert("Unable to delete");
        }
    }
</script>

<nav class="nav align-items-center p-2">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="79" zoomAndPan="magnify" viewBox="0 0 236.87999 131.999998" height="88" preserveAspectRatio="xMidYMid meet" version="1.0"><defs><g/><clipPath id="5e6d5fa0b5"><path d="M 62.359375 0.519531 L 174.804688 0.519531 L 174.804688 86.726562 L 62.359375 86.726562 Z M 62.359375 0.519531 " clip-rule="nonzero"/></clipPath></defs><g clip-path="url(#5e6d5fa0b5)"><path fill="#38b6ff" d="M 93.1875 36.445312 C 90.984375 37.710938 90.214844 39.855469 89.957031 42.335938 L 77.625 35.214844 L 72.5625 38.132812 L 72.5625 41.25 L 89.828125 51.214844 L 89.828125 67.546875 C 89.828125 70.921875 92.433594 72.867188 95.40625 74.628906 L 115.113281 86.003906 C 118.03125 87.675781 121.023438 86.390625 124.03125 84.703125 L 143.738281 73.324219 C 146.621094 71.636719 147.003906 68.410156 147.042969 64.957031 L 147.042969 51.214844 L 169.574219 38.207031 C 175.390625 34.847656 176.894531 33.472656 169.574219 29.25 L 123.628906 2.738281 C 118.691406 -0.125 117.847656 0.0742188 112.785156 2.992188 L 67.296875 29.25 C 59.972656 33.472656 61.496094 34.847656 67.296875 38.207031 L 67.296875 50.574219 C 64.652344 51.636719 64.230469 55.234375 66.582031 56.886719 C 66.269531 57.308594 66.066406 57.839844 66.066406 58.425781 L 66.066406 70.445312 L 71.203125 70.445312 L 71.203125 58.425781 C 71.203125 57.859375 71.019531 57.324219 70.691406 56.886719 C 72.820312 55.398438 72.765625 52.351562 70.542969 50.867188 L 69.976562 50.574219 L 69.976562 36.644531 L 114.910156 10.699219 C 119.023438 8.316406 118.453125 8.699219 123.792969 11.78125 L 123.792969 24.957031 L 121.757812 23.78125 C 118.839844 22.113281 115.847656 23.398438 112.839844 25.085938 L 93.167969 36.445312 Z M 147.003906 25.175781 L 158.453125 31.785156 C 161.113281 33.324219 162.125 33.527344 160.636719 34.390625 L 147.042969 42.242188 L 147.003906 25.160156 Z M 139.28125 33.910156 C 145.042969 37.234375 145.003906 37.546875 139.28125 33.910156 Z M 97.589844 62.097656 L 97.589844 47.730469 C 97.609375 43.65625 98.582031 42.335938 101.976562 40.335938 L 114.03125 33.378906 C 117.460938 31.417969 119.09375 31.25 122.617188 33.269531 L 131.519531 38.40625 L 131.519531 16.277344 L 139.28125 20.753906 L 139.28125 61.894531 C 139.261719 65.839844 138.601562 67.34375 135.078125 69.398438 L 122.636719 76.59375 L 118.433594 79.015625 L 114.050781 76.480469 L 101.996094 69.527344 C 98.582031 67.546875 97.609375 66.207031 97.609375 62.132812 Z M 97.589844 62.097656 " fill-opacity="1" fill-rule="evenodd"/></g><path fill="#000000" d="M 114.875 41.820312 L 106.875 46.445312 C 105.515625 47.234375 105.351562 48.738281 105.332031 50.335938 L 105.332031 60.664062 C 105.332031 62.222656 106.5625 63.125 107.9375 63.949219 L 108.304688 64.167969 L 116.875 69.125 L 118.417969 70.003906 L 129.976562 63.324219 C 131.316406 62.554688 131.5 61.050781 131.519531 59.453125 L 131.519531 47.324219 L 119.957031 40.664062 L 118.417969 39.785156 L 114.855469 41.839844 Z M 114.875 41.820312 " fill-opacity="1" fill-rule="evenodd"/><g fill="#000000" fill-opacity="1"><g transform="translate(81.032816, 114.58893)"><g><path d="M 7 -12.90625 C 6.519531 -12.90625 6.125 -12.773438 5.8125 -12.515625 C 5.507812 -12.265625 5.359375 -11.898438 5.359375 -11.421875 C 5.359375 -10.941406 5.5 -10.554688 5.78125 -10.265625 C 6.070312 -9.984375 6.441406 -9.765625 6.890625 -9.609375 C 7.347656 -9.453125 7.851562 -9.300781 8.40625 -9.15625 C 8.96875 -9.007812 9.523438 -8.835938 10.078125 -8.640625 C 10.628906 -8.441406 11.132812 -8.191406 11.59375 -7.890625 C 12.050781 -7.597656 12.421875 -7.175781 12.703125 -6.625 C 12.984375 -6.082031 13.125 -5.429688 13.125 -4.671875 C 13.125 -3.347656 12.582031 -2.210938 11.5 -1.265625 C 10.425781 -0.316406 9.003906 0.15625 7.234375 0.15625 C 5.460938 0.15625 4.035156 -0.265625 2.953125 -1.109375 C 1.878906 -1.960938 1.34375 -3.171875 1.34375 -4.734375 L 5.40625 -4.734375 C 5.507812 -3.484375 6.148438 -2.859375 7.328125 -2.859375 C 7.878906 -2.859375 8.3125 -3.003906 8.625 -3.296875 C 8.9375 -3.585938 9.09375 -3.957031 9.09375 -4.40625 C 9.09375 -4.851562 8.953125 -5.21875 8.671875 -5.5 C 8.390625 -5.78125 8.019531 -6.003906 7.5625 -6.171875 C 7.113281 -6.335938 6.609375 -6.488281 6.046875 -6.625 C 5.484375 -6.769531 4.925781 -6.945312 4.375 -7.15625 C 3.832031 -7.363281 3.332031 -7.613281 2.875 -7.90625 C 2.414062 -8.195312 2.046875 -8.613281 1.765625 -9.15625 C 1.484375 -9.695312 1.34375 -10.34375 1.34375 -11.09375 C 1.34375 -12.550781 1.882812 -13.71875 2.96875 -14.59375 C 4.0625 -15.476562 5.453125 -15.921875 7.140625 -15.921875 C 8.835938 -15.921875 10.207031 -15.535156 11.25 -14.765625 C 12.289062 -13.992188 12.832031 -12.785156 12.875 -11.140625 L 8.71875 -11.140625 C 8.65625 -11.703125 8.472656 -12.132812 8.171875 -12.4375 C 7.867188 -12.75 7.476562 -12.90625 7 -12.90625 Z M 7 -12.90625 "/></g></g></g><g fill="#000000" fill-opacity="1"><g transform="translate(98.98318, 114.58893)"><g><path d="M 10.125 -3.9375 C 10.675781 -4.46875 10.953125 -5.222656 10.953125 -6.203125 C 10.953125 -7.191406 10.675781 -7.953125 10.125 -8.484375 C 9.570312 -9.023438 8.9375 -9.296875 8.21875 -9.296875 C 7.507812 -9.296875 6.878906 -9.03125 6.328125 -8.5 C 5.773438 -7.976562 5.5 -7.222656 5.5 -6.234375 C 5.5 -5.253906 5.773438 -4.492188 6.328125 -3.953125 C 6.878906 -3.421875 7.507812 -3.15625 8.21875 -3.15625 C 8.9375 -3.15625 9.570312 -3.414062 10.125 -3.9375 Z M 5.5 -10.84375 C 6.351562 -12.019531 7.570312 -12.609375 9.15625 -12.609375 C 10.738281 -12.609375 12.082031 -12.007812 13.1875 -10.8125 C 14.289062 -9.613281 14.84375 -8.082031 14.84375 -6.21875 C 14.84375 -4.351562 14.289062 -2.820312 13.1875 -1.625 C 12.082031 -0.4375 10.75 0.15625 9.1875 0.15625 C 7.625 0.15625 6.394531 -0.5 5.5 -1.8125 L 5.5 5.953125 L 1.671875 5.953125 L 1.671875 -12.46875 L 5.5 -12.46875 Z M 5.5 -10.84375 "/></g></g></g><g fill="#000000" fill-opacity="1"><g transform="translate(118.073534, 114.58893)"><g><path d="M 5.15625 -13.875 C 4.726562 -13.445312 4.203125 -13.234375 3.578125 -13.234375 C 2.953125 -13.234375 2.421875 -13.445312 1.984375 -13.875 C 1.554688 -14.3125 1.34375 -14.847656 1.34375 -15.484375 C 1.34375 -16.117188 1.554688 -16.648438 1.984375 -17.078125 C 2.421875 -17.515625 2.953125 -17.734375 3.578125 -17.734375 C 4.203125 -17.734375 4.726562 -17.515625 5.15625 -17.078125 C 5.59375 -16.648438 5.8125 -16.117188 5.8125 -15.484375 C 5.8125 -14.847656 5.59375 -14.3125 5.15625 -13.875 Z M 1.671875 0 L 1.671875 -12.46875 L 5.5 -12.46875 L 5.5 0 Z M 1.671875 0 "/></g></g></g><g fill="#000000" fill-opacity="1"><g transform="translate(128.736903, 114.58893)"><g><path d="M 5.5 -12.46875 L 5.5 -10.15625 C 6.394531 -11.789062 7.585938 -12.609375 9.078125 -12.609375 L 9.078125 -8.71875 L 8.140625 -8.71875 C 7.253906 -8.71875 6.59375 -8.507812 6.15625 -8.09375 C 5.71875 -7.675781 5.5 -6.945312 5.5 -5.90625 L 5.5 0 L 1.671875 0 L 1.671875 -12.46875 Z M 5.5 -12.46875 "/></g></g></g><g fill="#000000" fill-opacity="1"><g transform="translate(141.702604, 114.58893)"><g><path d="M 6.96875 0.15625 C 5.15625 0.15625 3.664062 -0.425781 2.5 -1.59375 C 1.34375 -2.769531 0.765625 -4.328125 0.765625 -6.265625 C 0.765625 -8.203125 1.335938 -9.742188 2.484375 -10.890625 C 3.640625 -12.035156 5.132812 -12.609375 6.96875 -12.609375 C 8.800781 -12.609375 10.320312 -12.039062 11.53125 -10.90625 C 12.738281 -9.78125 13.34375 -8.207031 13.34375 -6.1875 C 13.34375 -5.757812 13.316406 -5.359375 13.265625 -4.984375 L 4.671875 -4.984375 C 4.742188 -4.429688 4.988281 -3.976562 5.40625 -3.625 C 5.820312 -3.28125 6.269531 -3.109375 6.75 -3.109375 C 7.238281 -3.109375 7.601562 -3.15625 7.84375 -3.25 C 8.082031 -3.351562 8.257812 -3.453125 8.375 -3.546875 C 8.488281 -3.640625 8.632812 -3.800781 8.8125 -4.03125 L 12.953125 -4.03125 C 12.585938 -2.769531 11.867188 -1.753906 10.796875 -0.984375 C 9.722656 -0.222656 8.445312 0.15625 6.96875 0.15625 Z M 9.375 -7.375 C 9.3125 -7.957031 9.054688 -8.429688 8.609375 -8.796875 C 8.160156 -9.160156 7.628906 -9.34375 7.015625 -9.34375 C 6.410156 -9.34375 5.898438 -9.160156 5.484375 -8.796875 C 5.066406 -8.429688 4.804688 -7.957031 4.703125 -7.375 Z M 9.375 -7.375 "/></g></g></g></svg>
    <a class="nav-link active" href="/">{studentId}</a>
    <button class="btn btn-dark ms-auto" on:click={() => (showModal = true)}>
        <div class="m-auto">
            <span class="mr-2">
                <svg fill="#FFFFFF" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
                    width="20px" height="20px" viewBox="0 0 902.86 902.86"
                    xml:space="preserve">
                <g>
                    <g>
                        <path d="M671.504,577.829l110.485-432.609H902.86v-68H729.174L703.128,179.2L0,178.697l74.753,399.129h596.751V577.829z
                            M685.766,247.188l-67.077,262.64H131.199L81.928,246.756L685.766,247.188z"/>
                        <path d="M578.418,825.641c59.961,0,108.743-48.783,108.743-108.744s-48.782-108.742-108.743-108.742H168.717
                            c-59.961,0-108.744,48.781-108.744,108.742s48.782,108.744,108.744,108.744c59.962,0,108.743-48.783,108.743-108.744
                            c0-14.4-2.821-28.152-7.927-40.742h208.069c-5.107,12.59-7.928,26.342-7.928,40.742
                            C469.675,776.858,518.457,825.641,578.418,825.641z M209.46,716.897c0,22.467-18.277,40.744-40.743,40.744
                            c-22.466,0-40.744-18.277-40.744-40.744c0-22.465,18.277-40.742,40.744-40.742C191.183,676.155,209.46,694.432,209.46,716.897z
                            M619.162,716.897c0,22.467-18.277,40.744-40.743,40.744s-40.743-18.277-40.743-40.744c0-22.465,18.277-40.742,40.743-40.742
                            S619.162,694.432,619.162,716.897z"/>
                    </g>
                </g>
                </svg>
            </span>
        </div> 
    </button>
    <Modal bind:showModal={showModal}>
        <h2 slot="header">
            Cart
        </h2>
            {#each cart as course (course)}
                <div class="cart-item-container mb-2 d-flex">
                    <li class="cart-item">{course}</li>
                    <button on:click={() => handleDelete(course)} class="btn btn-dark">Remove</button>
                    <button class="btn btn-success">Enroll</button>
                </div>
            {/each}
    </Modal>
</nav>

<style>
    .nav {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .nav-link.active {
        opacity: 1;
    }
    .nav-link {
        color: black;
        opacity: 0.5;
    }
    .nav-link:hover {
        opacity: 1;
    }
    .cart-item {
        margin-right: auto;
    }
    .btn-success {
        margin-left:10px;
        background-color: #38b6ff;
        border: none;
    }
</style>